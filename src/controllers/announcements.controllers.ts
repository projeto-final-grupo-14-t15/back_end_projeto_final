import { Request, Response } from "express";
import {
   TAnnouncementRequest,
   TAnnouncementResponse,
} from "../interfaces/announcements.interfaces";
import {
   announcementSchema,
   announcementSchemaRequest,
   announcementSchemaResponse,
   announcementSchemaResponseDois,
   announcementSchemaUpadate,
} from "../schemas/announcements.schemas";
import { Announcement } from "../entities/announcements.entitie";
import { createAnnouncementService } from "../services/announcements/createAnnouncement.service";
import { listAnnouncementService } from "../services/announcements/listAnnouncement.service";
import { updateAnnouncementService } from "../services/announcements/updateAnnouncement.service";
import deleteAnnouncementService from "../services/announcements/deleteAnnouncement.service";
import { filterAnnouncementService } from "../services/announcements/filterAnnouncement.services";
import { createPhotoService } from "../services/photos/createPhotos.service";
import { Photo } from "../entities/photos.entitie";
import { TPhotoRequest } from "../interfaces/photos.interfaces";
import { AppError } from "../error/error";
import { getAllUserAnnouncementsService } from "../services/announcements/getAllUserAnnoucements.service";
import { updatePhotoService } from "../services/photos/updatePhotos.service";

const createAnnouncementController = async (
   req: Request,
   res: Response
): Promise<Response> => {
   const announcementData: TAnnouncementRequest =
      announcementSchemaRequest.parse(req.body);

   const userId = res.locals.token.id;

   console.log(announcementData.fipePrice)
   console.log("TEXT OR NUMBER")

   const newAnnouncement: Announcement = await createAnnouncementService(
      announcementData,
      userId
   );
   const response: TAnnouncementResponse =
      announcementSchemaResponse.parse(newAnnouncement);

   const photos = req.body.photos;

   if (!photos) {
      throw new AppError("Photo field not found", 404);
   }

   photos.map(async (photo: string) => {
      const data: TPhotoRequest = { link: photo };

      const newPhoto: Photo = await createPhotoService(data, response.id);
   });

   return res.status(201).json(response);
};

// const updateAnnouncementController = async (
//    req: Request,
//    res: Response
// ): Promise<Response> => {
//    const announcementData = req.body;

//    const announcementId = Number(req.params.id);

//    const newAnnouncement = await updateAnnouncementService(
//       announcementData,
//       announcementId
//    );

//    return res.status(200).json(newAnnouncement);
// };

const updateAnnouncementController = async (
   req: Request,
   res: Response
): Promise<Response> => {
   const announcementData = req.body;
   const announcementId = Number(req.params.id);
   console.log('FULL2')
   console.log(announcementData)
   console.log('FULL2')

   const newAnnouncement = await updateAnnouncementService(
      announcementData,
      announcementId
   );

   // Update photos if new photo URLs are provided
   if (announcementData.photos) {
      console.log(announcementData)
      await updatePhotoService(newAnnouncement.id, announcementData.photos);
   }

   const parsedResponse = announcementSchemaUpadate.parse(newAnnouncement);

   return res.status(200).json(parsedResponse);
};

const deleteAnnouncementController = async (
   req: Request,
   res: Response
): Promise<Response> => {
   const announcementId: number = parseInt(req.params.id);
   await deleteAnnouncementService(announcementId);

   return res.status(204).send();
};

const listAnnouncementController = async (
   req: Request,
   res: Response
): Promise<Response> => {
   const announcementId: number = Number(req.params.id);

   const response = await listAnnouncementService(announcementId);

   console.log('AQUI ESTÁ A RESPONSE ANTES DO PARSE!!!!!!')
   console.log(response)
   console.log('AQUI ESTÁ A RESPONSE ANTES DO PARSE!!!!!!')

   const parsedResponse = announcementSchemaResponseDois.parse(response);

   return res.status(200).json(parsedResponse);
};

const filterAnnouncementController = async (
   req: Request,
   res: Response
): Promise<Response> => {
   const { brand, model, color, year, fuel, minPrice, maxPrice, minKm, maxKm } =
      req.query;

   const listAnnouncement = await filterAnnouncementService(
      brand,
      model,
      color,
      year,
      fuel,
      minPrice,
      maxPrice,
      minKm,
      maxKm
   );

   return res.status(200).json(listAnnouncement);
};

const getAllUserAnnouncements = async (req: Request, res: Response): Promise<Response> => {

   const userId = Number(req.params.id);
 
   const userAnnouncements: TAnnouncementRequest[] = await getAllUserAnnouncementsService(userId);
 
   return res.status(200).json(userAnnouncements);
};

export {
   createAnnouncementController,
   updateAnnouncementController,
   deleteAnnouncementController,
   listAnnouncementController,
   filterAnnouncementController,
   getAllUserAnnouncements
};

